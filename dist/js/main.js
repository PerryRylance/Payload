window.Payload=function(){window.stats=new Stats,stats.showPanel(0),stats.domElement.style.zIndex=999,stats.domElement.style.position="fixed",document.body.appendChild(stats.domElement),window.Box2D=Box2D({TOTAL_MEMORY:1048576*Payload.BOX2D_MEMORY_MB})},Payload.BOX2D_MEMORY_MB=256,Payload.extend=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t},Payload.assert=function(t,e){if(!0!==t){if(!1!==t)throw new Error("Invalid assertion");if(!e)throw new Error("Assertion failed");throw new Error(e)}},Payload.prototype.init=function(){var e=this;this.assets=new Payload.Assets,this.assets.on("load",function(t){e.game=new Payload.Game}),this.assets.load()},Payload.Game=function(){this.world=new Payload.World},Payload.Interaction=function(t,e){var a=this;this.camera=t,this.element=e,this.isDragging=!1,e.addEventListener("mousedown",function(t){a.onMouseDown(t)}),e.addEventListener("mouseup",function(t){a.onMouseUp(t)}),e.addEventListener("mousemove",function(t){a.onMouseMove(t)}),e.addEventListener("mousewheel",function(t){a.onMouseWheel(t)})},Payload.Interaction.prototype.onMouseDown=function(t){this.isDragging=!0},Payload.Interaction.prototype.onMouseUp=function(t){this.isDragging=!1},Payload.Interaction.prototype.onMouseMove=function(t){this.isDragging&&(this.camera.position.x-=t.movementX/this.camera.zoom,this.camera.position.y-=t.movementY/this.camera.zoom)},Payload.Interaction.prototype.onMouseWheel=function(t){var e=t.deltaY<0?1:-1,a=.1*this.camera.zoom;this.camera.zoom+=e*a,this.camera.updateProjectionMatrix()},window.addEventListener("load",function(t){window.payload=new Payload,payload.init()}),Payload.Units={RATIO:20,physicsToGraphics:function(t){return t*Payload.Units.GRAPHICS_TO_PHYSICS},graphicsToPhysics:function(t){return t*Payload.Units.PHYSICS_TO_GRAPHICS}},Payload.Units.GRAPHICS_TO_PHYSICS=1/Payload.Units.RATIO,Payload.Units.PHYSICS_TO_GRAPHICS=Payload.Units.RATIO,Payload.Units.p2g=Payload.Units.physicsToGraphics,Payload.Units.g2p=Payload.Units.graphicsToPhysics,Payload.EventDispatcher=function(){Payload.assert(this instanceof Payload.EventDispatcher,"Inheritence assertion failed, did you forget to call extend?"),this._listenersByType={}},Payload.EventDispatcher.prototype.addEventListener=function(t,e,a,o){var i=t.split(/\s+/);if(1<i.length)for(var n=0;n<i.length;n++)this.addEventListener(i[n],e,a,o);else{if(!(e instanceof Function))throw new Error("Listener must be a function");var s=this._listenersByType.hasOwnProperty(t)?this._listenersByType[t]:this._listenersByType[t]=[],r={listener:e,thisObject:a||this,useCapture:!!o};s.push(r)}},Payload.EventDispatcher.prototype.on=Payload.EventDispatcher.prototype.addEventListener,Payload.EventDispatcher.prototype.removeEventListener=function(t,e,a,o){var i,n;if(i=this._listenersByType[t]){a=a||this,o=!!o;for(var s=0;s<i.length;s++)if(n=i[s],(1==arguments.length||n.listener==e)&&n.thisObject==a&&n.useCapture==o)return void i.splice(s,1)}},Payload.EventDispatcher.prototype.off=Payload.EventDispatcher.prototype.removeEventListener,Payload.EventDispatcher.prototype.hasEventListener=function(t){return!!_listenersByType[t]},Payload.EventDispatcher.prototype.dispatchEvent=function(t){if(!(t instanceof Payload.Event))if("string"==typeof t)t=new Payload.Event(t);else{var e=t;for(var a in t=new Payload.Event,e)t[a]=e[a]}for(var o=[],i=(t.target=this).parent;null!=i;i=i.parent)o.unshift(i);t.phase=Payload.Event.CAPTURING_PHASE;for(var n=0;n<o.length&&!t._cancelled;n++)o[n]._triggerListeners(t);if(!t._cancelled){for(t.phase=Payload.Event.AT_TARGET,this._triggerListeners(t),t.phase=Payload.Event.BUBBLING_PHASE,n=o.length-1;0<=n&&!t._cancelled;n--)o[n]._triggerListeners(t);for(var s=this.element,i=this.parent;null!=i;i=i.parent)i.element&&(s=i.element);if(s){var r={};for(var d in t){var h=t[d];"type"==d&&(h+=".Payload"),r[d]=h}$(s).trigger(r)}}},Payload.EventDispatcher.prototype.trigger=Payload.EventDispatcher.prototype.dispatchEvent,Payload.EventDispatcher.prototype._triggerListeners=function(t){var e,a;if(e=this._listenersByType[t.type])for(var o=0;o<e.length;o++)a=e[o],t.phase==Payload.Event.CAPTURING_PHASE&&!a.useCapture||a.listener.call(e[o].thisObject,t)},Payload.World=function(t){Payload.EventDispatcher.apply(this,arguments),t=t||{},this.options=t=$.extend(!0,{},Payload.World.defaults,t),this.entities=[],this.planets=[],this.ships=[],this.initPhysics(),this.initGraphics(),this.initPlanets(t),this.initShips(t),this.step()},Payload.extend(Payload.World,Payload.EventDispatcher),Payload.World.defaults={planet:{count:{minimum:3,maximum:9},radius:{minimum:50,maximum:1024},friction:.9,restitution:0}},Payload.World.prototype.initPhysics=function(){this.b2World=new Box2D.b2World(new Box2D.b2Vec2(0,0)),this.listener=new Box2D.JSContactListener,this.listener.BeginContact=function(t){var e=Box2D.wrapPointer(t,Box2D.b2Contact),a=e.GetFixtureA(),o=e.GetFixtureB(),i=a.GetBody(),n=o.GetBody(),s=i.entity,r=n.entity;s&&r&&(s.onCollision(r,a,o),r.onCollision(s,o,a))},this.listener.EndContact=function(){},this.listener.PreSolve=function(){},this.listener.PostSolve=function(){},this.b2World.SetContinuousPhysics(1),this.b2World.SetContactListener(this.listener)},Payload.World.prototype.initGraphics=function(){var t=window.innerWidth,e=window.innerHeight;this.scene=new THREE.Scene,this.camera=new THREE.OrthographicCamera(t/-2,t/2,e/2,e/-2,1,1e3),this.camera.position.z=-500,this.camera.rotation.set(-Math.PI,0,0),this.scene.add(this.camera),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(t,e),document.querySelector("#scene").appendChild(this.renderer.domElement),this.interaction=new Payload.Interaction(this.camera,this.renderer.domElement)},Payload.World.prototype.initPlanets=function(t){for(var e=t.planet.count.minimum+Math.round(Math.random()*(t.planet.count.maximum-t.planet.count.minimum)),a=0;a<e;a++){var o=new Payload.Planet(this,{position:{x:(-.5+Math.random())*t.planet.radius.maximum*12,y:(-.5+Math.random())*t.planet.radius.maximum*12}});this.add(o)}},Payload.World.prototype.initShips=function(t){},Payload.World.prototype.add=function(t){Payload.assert(t instanceof Payload.Entity,"Not an Entity"),this.entities.push(t),t.parent=this,t.object3d&&this.scene.add(t.object3d),t.trigger("added")},Payload.World.prototype.remove=function(t){Payload.assert(t instanceof Payload.Entity,"Not an Entity");var e=this.entities.indexOf(t);Payload.assert(-1!=e,"Not in entity list"),this.entities.splice(e,1),this.entity.parent=null,this.entity.trigger("removed")},Payload.World.prototype.step=function(){var t=this;window.stats&&window.stats.begin(),this.b2World.Step(1/30,10,10);for(var e=0;e<this.entities.length;e++)this.entities[e].update();this.renderer.render(this.scene,this.camera),this.debugDrawEnabled&&(this.context.resetTransform(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.translate(this.canvas.width/2,this.canvas.height/2),this.context.scale(this.camera.zoom,this.camera.zoom),this.context.translate(-this.camera.position.x,-this.camera.position.y),this.context.scale(Payload.Units.PHYSICS_TO_GRAPHICS,Payload.Units.PHYSICS_TO_GRAPHICS),this.b2World.DrawDebugData()),requestAnimationFrame(function(){t.step()}),window.stats&&window.stats.end()},Payload.World.prototype.enableDebugDraw=function(){var t=this._debugDraw=getCanvasDebugDraw(),e=window.innerWidth,a=window.innerHeight;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="debug-draw",this.canvas.width=e,this.canvas.height=a,this.context=this.canvas.getContext("2d"),document.querySelector("#scene").appendChild(this.canvas),window.context=this.context,this.b2World.SetDebugDraw(t),t.SetFlags(25)),this.debugDrawEnabled=!0},Payload.Entity=function(t,e){Payload.assert(t instanceof Payload.World),Payload.EventDispatcher.call(this),this.world=t,this.initPhysics(),this.initGraphics(),this.initAudio(),this.setOptions(e)},Payload.extend(Payload.Entity,Payload.EventDispatcher),Object.defineProperty(Payload.Entity.prototype,"position",{get:function(){if(this.b2Body){var t=this.b2Body.GetWorldCenter();return{x:t.get_x()*Payload.Units.PHYSICS_TO_GRAPHICS,y:t.get_y()*Payload.Units.PHYSICS_TO_GRAPHICS}}if(this.object3d)return{x:this.object3d.position.x,y:this.object3d.position.y};throw new Error("Entity has no body or object to get position from")},set:function(t){Payload.assert("x"in t&&$.isNumeric(t.x)),Payload.assert("y"in t&&$.isNumeric(t.y));var e=t.x,a=t.y;this.b2Body&&this.b2Body.SetTransform(new Box2D.b2Vec2(e*Payload.Units.GRAPHICS_TO_PHYSICS,a*Payload.Units.GRAPHICS_TO_PHYSICS),0),this.object3d&&this.object3d.position.set(e,a,0)}}),Payload.Entity.prototype.initPhysics=function(){},Payload.Entity.prototype.initGraphics=function(){},Payload.Entity.prototype.initAudio=function(){},Payload.Entity.prototype.setOptions=function(t){t&&"position"in t&&(this.position=t.position)},Payload.Entity.prototype.update=function(){var t,e,a,o;this.b2Body&&this.object3d&&(t=this.b2Body.GetWorldCenter(),e=this.b2Body.GetAngle(),a=t.get_x()*Payload.Units.PHYSICS_TO_GRAPHICS,o=t.get_y()*Payload.Units.PHYSICS_TO_GRAPHICS,this.object3d.position.set(a,o,0),this.object3d.rotation.set(0,0,e))},Payload.Entity.prototype.onCollision=function(t,e,a){},Payload.Entity.prototype.remove=function(){this.b2Body&&(this.world.b2World.DestroyBody(this.b2Body),this.b2Body=null),this.object3d&&(this.world.scene.remove(this.object3d),this.object3d=null),this.world.remove(this),this.world=null},Payload.Planet=function(t,e){this.fixtureDestructionQueue=[],this.fixturesByFaceIndex=[],this.world=t,this.initMesh(e),Payload.Entity.apply(this,arguments)},Payload.extend(Payload.Planet,Payload.Entity),Payload.Planet.spherize=function(t){var e=512,a=document.createElement("canvas");a.width=e,a.height=e;var o=a.getContext("2d");o.drawImage(t,0,0);var i=document.createElement("canvas");i.width=i.height=e;var n=i.getContext("2d");n.fillStyle="red",n.fillRect(0,0,512,512);var s=o.getImageData(0,0,e,e).data,r=s.slice();r.fill(0);for(var d,h,l=0;l<e;l++)for(var c=2*l/e-1,y=c*c,p=0;p<e;p++){var u,P,f,v,m,E,g=2*p/e-1,w=g*g,_=Math.sqrt(w+y);1<_||(1<(E=(_+(1-(E=Math.sqrt(1-_*_))))/2)||(u=Math.atan2(c,g),P=E*Math.cos(u),f=E*Math.sin(u),v=parseInt((1+P)*e/2),m=parseInt((1+f)*e/2),0,d=4*m*e+4*v,r[h=4*l*e+4*p]=s[d],r[1+h]=s[1+d],r[2+h]=s[2+d],r[3+h]=s[3+d]))}var x=new ImageData(e,e);return x.data.set(r),o.putImageData(x,0,0),a},Payload.Planet.prototype.initMesh=function(t){for(var e=this.world.options.planet.radius.minimum,a=this.world.options.planet.radius.maximum,o=this._radius=e+Math.random()*Math.round(a-e),i=this._density=.5+2*Math.random(),n=this._area=Math.PI*Math.pow(o,2),s=this._sides=Math.round(Math.sqrt(o)*Math.PI),r=[],d=0;d<s;d++){var h=d/s*Math.PI*2;r.push([0+Math.sin(h)*o,0+Math.cos(h)*o])}for(var l=Math.round(Math.sqrt(n))*i,d=0;d<l;d++){var c=2*Math.random()*Math.PI,y=o*Math.pow(Math.random(),.5);r.push([0+Math.sin(c)*y,0+Math.cos(c)*y])}var p=Delaunator.from(r);this._vertices=r,this._indices=p.triangles},Payload.Planet.prototype.initPhysics=function(t){var e=this._vertices,a=this._indices;function o(t,e){return e=e||1,new Box2D.b2Vec2(t[0]*e,t[1]*e)}this._destructionGravityMultiplier=1,this.b2CenterOfGravity=new Box2D.b2Vec2,this.b2BodyDef=new Box2D.b2BodyDef,this.b2Body=this.world.b2World.CreateBody(this.b2BodyDef);for(var i=0;i<a.length;i+=3){var n=[];n.push(o(e[a[i+2]],Payload.Units.GRAPHICS_TO_PHYSICS)),n.push(o(e[a[i+1]],Payload.Units.GRAPHICS_TO_PHYSICS)),n.push(o(e[a[i]],Payload.Units.GRAPHICS_TO_PHYSICS)),n.push(o(e[a[i+2]],Payload.Units.GRAPHICS_TO_PHYSICS));var s=function(t){for(var e=new Box2D.b2PolygonShape,a=Box2D._malloc(8*t.length),o=0,i=0;i<t.length;i++)Box2D.HEAPF32[a+o>>2]=t[i].get_x(),Box2D.HEAPF32[a+(o+4)>>2]=t[i].get_y(),o+=8;var n=Box2D.wrapPointer(a,Box2D.b2Vec2);return e.Set(n,t.length),e}(n),r=new Box2D.b2FixtureDef;r.set_density(this._density),r.set_friction(this.world.options.planet.friction),r.set_restitution(this.world.options.planet.restitution),r.set_shape(s);var d=this.b2Body.CreateFixture(r);this.fixturesByFaceIndex[parseInt(i/3)]=d}},Payload.Planet.prototype.initGraphics=function(){var t,e={damage:null,surface:null};for(var a in e){var o=payload.assets.textures.planet[a].random(),i=Payload.Planet.spherize(o.resource.image);e[a]=new THREE.MeshBasicMaterial,e[a].map=new THREE.CanvasTexture(i)}this.object3d=new THREE.Object3D,this.damage=new THREE.Mesh(new THREE.CircleGeometry(this._radius,this._sides),e.damage),this.object3d.add(this.damage),this.geometry=new THREE.Geometry;for(var n=0;n<this._vertices.length;n++)t=this._vertices[n],this.geometry.vertices.push(new THREE.Vector3(t[0],t[1],0));for(n=0;n<this._indices.length;n+=3){var s=parseInt(n/3),r=this.fixturesByFaceIndex[s],d=new THREE.Face3(this._indices[n],this._indices[n+1],this._indices[n+2]);(d.fixture=r).face=d,this.geometry.faces.push(d);for(var h=[],l=2*this._radius,c=0;c<3;c++){var y=this._vertices[this._indices[n+c]],p=new THREE.Vector2(.5+y[0]/l,.5+y[1]/l);h.push(p)}this.geometry.faceVertexUvs[0].push(h)}this.object3d=new THREE.Mesh(this.geometry,e.surface),delete this.fixturesByFaceIndex},Payload.Ship=function(){Payload.Entity.apply(this,arguments)},Payload.extend(Payload.Ship,Payload.Entity),Payload.Assets=function(){var o=this;Payload.EventDispatcher.call(this),this.collections=[],this.manager=new THREE.LoadingManager,this.manager.onStart=function(t,e,a){o.onProgress(t,e,a)},this.manager.onProgress=function(t,e,a){o.onProgress(t,e,a)},this.manager.onLoad=function(){o.onLoad()},this.manager.onError=function(t){o.onError(t)}},Payload.extend(Payload.Assets,Payload.EventDispatcher),Payload.Assets.prototype.load=function(){var o=this;$.ajax("assets.json",{success:function(t,e,a){o.loadFromJSON(t)},error:function(t,e,a){throw new Error("Error loading assets file")}})},Payload.Assets.prototype.loadFromJSON=function(t){for(var e in Payload.assert("object"==typeof t,"Invalid assets file"),t=t[""])this[e]=new Payload.Assets.Collection(t[e])},Payload.Assets.prototype.onProgress=function(t,e,a){this.trigger({type:"progress",amount:e/a,percent:e/a*100})},Payload.Assets.prototype.onError=function(t,e,a){throw new Error("Failed to load asset")},Payload.Assets.prototype.onLoad=function(){this.trigger("load")},Payload.Assets.Asset=function(t){var e=this,a=this.getLoaderFromFilename(t);this.loader=new a(payload.assets.manager),this.loader.load("/assets"+t,function(t){e.resource=t})},Payload.Assets.Asset.prototype.getLoaderFromFilename=function(t){var e=/\.[a-z0-9]+$/i.exec(t);if(!e||!e[0])throw new Error("Don't know how to load asset");switch(e[0].toLowerCase()){case".png":case".jpg":case".jpeg":return THREE.TextureLoader}},Payload.Assets.Collection=function(t){for(var e in this.assets={},t){var a=t[e];!function(t){var e=0;if("string"==typeof t)return 1;for(var a in t){if("string"!=typeof t[a])return;if(1<++e)return}}(a)?this[e]=new Payload.Assets.Collection(a):this.assets[e]=new Payload.Assets.Asset(a)}},Payload.Assets.Collection.prototype.random=function(){var t=Object.values(this.assets);return t[Math.floor(Math.random()*t.length)]},Payload.Event=function(t){if("string"==typeof t&&(this.type=t),this.bubbles=!0,this.cancelable=!0,this.phase=Payload.Event.PHASE_CAPTURE,this.target=null,this._cancelled=!1,"object"==typeof t)for(var e in t)this[e]=t[e]},Payload.Event.CAPTURING_PHASE=0,Payload.Event.AT_TARGET=1,Payload.Event.BUBBLING_PHASE=2,Payload.Event.prototype.stopPropagation=function(){this._cancelled=!0};
//# sourceMappingURL=main.js.map
